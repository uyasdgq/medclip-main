# MediCLIP 项目修改内容详细汇报

## 目录
1. [项目背景与目标](#1-项目背景与目标)
2. [整体架构概述](#2-整体架构概述)
3. [修改内容详解](#3-修改内容详解)
   - 3.1 [模型组件优化](#31-模型组件优化)
   - 3.2 [训练流程优化](#32-训练流程优化)
   - 3.3 [异常合成模块](#33-异常合成模块)
   - 3.4 [配置文件优化](#34-配置文件优化)
4. [实验结果](#4-实验结果)
5. [总结](#5-总结)

---

## 1. 项目背景与目标

### 1.1 原始项目
MediCLIP 是 MICCAI 2024 Early Accept 论文的官方实现，用于**少样本医学图像异常检测**。

**论文**: "MediCLIP: Adapting CLIP for Few-shot Medical Image Anomaly Detection"

**核心思想**: 将预训练的 CLIP 模型适配到医学影像领域，通过可学习提示词、适配器和合成异常任务实现高效的异常检测。

### 1.2 修改目标
- 提升 BUSI（乳腺超声）数据集的 image-auroc 至 92% 以上
- 优化模型训练稳定性
- 增强异常合成的多样性和真实性

---

## 2. 整体架构概述

### 2.1 模型流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         MediCLIP 整体流程                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   输入: 正常医学图像 (K-shot)                                            │
│              │                                                          │
│              ▼                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │              异常合成模块 (Anomaly Synthesis)                     │  │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │  │
│   │   │CutPaste  │  │Synomaly  │  │GaussInten│  │Identity  │       │  │
│   │   │  35%     │  │  30%     │  │  25%     │  │  10%     │       │  │
│   │   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │  │
│   │        └─────────────┴──────────────┴─────────────┘             │  │
│   │                          │                                      │  │
│   │                          ▼                                      │  │
│   │              (合成异常图像, GT Mask)                              │  │
│   └─────────────────────────┬───────────────────────────────────────┘  │
│                             │                                          │
│              ┌──────────────┴──────────────┐                          │
│              │                             │                          │
│              ▼                             ▼                          │
│   ┌─────────────────────┐      ┌─────────────────────┐               │
│   │  CLIP ViT-L/14      │      │  CoOp Prompt        │               │
│   │  (Frozen)           │      │  Learner            │               │
│   │                     │      │  (Trainable)        │               │
│   │  Layer 12/18/24     │      │                     │               │
│   │  多层特征提取        │      │  可学习提示词        │               │
│   └──────────┬──────────┘      └──────────┬──────────┘               │
│              │                            │                          │
│              ▼                            ▼                          │
│   ┌─────────────────────┐      ┌─────────────────────┐               │
│   │      Necker         │      │  CLIP Text Encoder  │               │
│   │  (多尺度特征对齐)    │      │     (Frozen)        │               │
│   └──────────┬──────────┘      └──────────┬──────────┘               │
│              │                            │                          │
│              ▼                            ▼                          │
│   ┌─────────────────────┐      ┌─────────────────────┐               │
│   │      Adapter        │      │   Text Features     │               │
│   │  (瓶颈结构+GELU)    │      │  [normal, abnormal] │               │
│   │  (Trainable)        │      │                     │               │
│   └──────────┬──────────┘      └──────────┬──────────┘               │
│              │                            │                          │
│              └─────────────┬──────────────┘                          │
│                            │                                          │
│                            ▼                                          │
│              ┌─────────────────────────────┐                          │
│              │        MapMaker             │                          │
│              │   (可学习层融合权重)         │                          │
│              │                             │                          │
│              │  Vision × Text → Map        │                          │
│              │  Softmax → [P_norm, P_abn]  │                          │
│              └──────────────┬──────────────┘                          │
│                             │                                          │
│                             ▼                                          │
│              ┌─────────────────────────────┐                          │
│              │   Focal Loss + Dice Loss    │                          │
│              └─────────────────────────────┘                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块说明

| 模块 | 功能 | 是否可训练 |
|------|------|-----------|
| CLIP ViT-L/14 | 视觉特征提取 | ❌ Frozen |
| Necker | 多尺度特征对齐 | ❌ Frozen |
| Adapter | 特征投影与适配 | ✅ Trainable |
| CoOp Prompt Learner | 可学习提示词 | ✅ Trainable |
| CLIP Text Encoder | 文本特征提取 | ❌ Frozen |
| MapMaker | 异常图生成 | ✅ Trainable |

---

## 3. 修改内容详解

### 3.1 模型组件优化

#### 3.1.1 Adapter 模块优化

**文件位置**: `models/Adapter.py`

**修改内容**: 将简单的线性投影改为瓶颈结构

